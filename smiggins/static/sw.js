var __awaiter=this&&this.__awaiter||function(n,s,c,r){return new(c=c||Promise)(function(t,e){function a(n){try{o(r.next(n))}catch(n){e(n)}}function i(n){try{o(r.throw(n))}catch(n){e(n)}}function o(n){var e;n.done?t(n.value):((e=n.value)instanceof c?e:new c(function(n){n(e)})).then(a,i)}o((r=r.apply(n,s||[])).next())})};let CAN_USE_BADGES="clearAppBadge"in navigator&&"setAppBadge"in navigator,BADGE_INTERVAL=9e5,badgeIntervalID=void 0;function fetchBadge(){fetch("/api/notifications").then(n=>n.arrayBuffer()).then(n=>new Uint8Array(n)).then(n=>{112===n[0]&&updateBadge(n[3])})}function updateBadge(n){console.log(n),CAN_USE_BADGES&&(n<=0?navigator.clearAppBadge():navigator.setAppBadge(n))}function resetBadgeInterval(){clearInterval(badgeIntervalID),badgeIntervalID=setInterval(fetchBadge,BADGE_INTERVAL)}resetBadgeInterval();let sw_self=self;function canUseNotifications(){return __awaiter(this,void 0,void 0,function*(){return"granted"===(yield navigator.permissions.query({name:"notifications"})).state})}function handleNotification(r){return __awaiter(this,void 0,void 0,function*(){canUseNotifications()||console.log("[SW] recieved message but can't show notif");var e=(null==r?void 0:r.text().split(";"))||[L.notifications.no_content_title,"none","",L.notifications.no_content_body],t=e[0],a=Number(e[1]),i=e[2],o=e[3],s=JSON.parse(e.slice(4).join(";"));let c=String(s);switch(resetBadgeInterval(),updateBadge(a),i){case"comment":case"quote":case"ping":c=lr(L.notifications[i],{n:s.display_name,u:s.username,c:s.content.replaceAll("\n","")});break;case"follow":c=lr(L.notifications.followed,{n:s.display_name,u:s.username});break;case"follow_request":c=lr(L.notifications.folreq,{n:s.display_name,u:s.username});break;case"message":c=lr(n(L.notifications.message,s.users-2),{n:s.display_name,u:s.username,c:String(s.users-2)});break;default:console.log("[SW] unknown notification type",i),c=L.notifications.no_content_body}sw_self.registration.showNotification(t,{body:c,data:o,icon:location.origin+"/favicon.ico"})})}sw_self.addEventListener("push",function(n){n.waitUntil(handleNotification(n.data))}),sw_self.addEventListener("message",function(n){if(console.log("message",n.data),"string"==typeof n.data)switch(n.data[0]){case"l":L=(L=LANGS[n.data.slice(1)||DEFAULT_LANGUAGE])||LANGS[DEFAULT_LANGUAGE];break;case"b":resetBadgeInterval(),updateBadge(Number(n.data.slice(1)))}}),sw_self.addEventListener("notificationclick",function(n){if("string"==typeof n.notification.data)switch(n.notification.data[0]){case"p":sw_self.clients.openWindow(`/p/${n.notification.data.slice(1)}/`);break;case"u":sw_self.clients.openWindow(`/u/${n.notification.data.slice(1)}/`);break;case"m":sw_self.clients.openWindow(`/message/${n.notification.data.slice(1)}/`)}}),console.log("[SW] init");let LANGS={en:{meta:{id:"en",name:"English",fallbacks:[],maintainers:[["trinkey","trinkey"]],past_maintainers:[]},notifications:{followed:"%n (@%u) started following you.",folreq:"%n (@%u) wants to follow you.",comment:"%n (@%u): %c",quote:"%n (@%u): %c",ping:"%n (@%u): %c",message:{0:"%n (@u) messaged you",1:"%n (@u) messaged you and %c other","*":"%n (@u) messaged you and %c others"},no_content_title:"Notification",no_content_body:"No notification context was given."}},en_GB:{meta:{id:"en_GB",name:"English (United Kingdom)",fallbacks:["en"],maintainers:[["trinkey","trinkey"]],past_maintainers:[]},notifications:{followed:"%n (@%u) started following you.",folreq:"%n (@%u) wants to follow you.",comment:"%n (@%u): %c",quote:"%n (@%u): %c",ping:"%n (@%u): %c",message:{0:"%n (@u) messaged you",1:"%n (@u) messaged you and %c other","*":"%n (@u) messaged you and %c others"},no_content_title:"Notification",no_content_body:"No notification context was given."}},es:{meta:{id:"es",name:"Español",fallbacks:["en"],maintainers:[["pq-on-tempe2","pquirrel"]],past_maintainers:[]},notifications:{followed:"%n (@%u) ahora te sigue.",folreq:"%n (@%u) te quiere seguir.",comment:"%n (@%u): %c",quote:"%n (@%u): %c",ping:"%n (@%u): %c",message:{0:"%n (@u) te envió un mensaje.",1:"%n (@u) les envió un mensaje a ti y %c otro.","*":"%n (@u) les envió un mensaje a ti y %c otros."},no_content_title:"Notificación",no_content_body:"No hay contexto para esta notificación."}}},DEFAULT_LANGUAGE="en",L;function lr(n,e){var t,a,i,o,s={};for([t,a]of Object.entries(e))s[t]=`TEMP_${Math.random()}`,n=n.replaceAll("%"+t,s[t]);for([i,o]of Object.entries(e))n=n.replaceAll(s[i],o);return n}function n(n,e){return n[e]||n["*"]}L=LANGS[DEFAULT_LANGUAGE];